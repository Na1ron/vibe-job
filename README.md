# Vibe Job Utilities

Этот репозиторий содержит два сценария для захвата и транскрибации аудио на Windows без зависимости от VB-Cable:

- `run_capture_with_audio_switch.py` — через **pycaw** переключает системное дефолтное устройство вывода (опционально) и запускает транскрибацию с loopback-захватом системного микса.
- `stream_transcribe.py` — подключается к выбранному входному устройству или к loopback системного выхода, разбивает поток на фреймы, определяет речь (WebRTC VAD или energy-based), передает звук в Whisper и, при включенном чате, в Groq Chat API.

## Логика работы

1. **Переключение устройств вывода и запуск** (`run_capture_with_audio_switch.py`):
   - Через pycaw находит устройство вывода по фрагменту имени (`--target-render`).
   - Делает найденное устройство системным дефолтом для ролей Console/Multimedia/Communications (если флаг не указан — ничего не меняет).
   - Запускает `stream_transcribe.py` в loopback-режиме, чтобы читать системный микс выбранного дефолтного выхода без VB-Cable.
   - После остановки восстанавливает исходный дефолтный вывод.
2. **Стриминговая транскрибация** (`stream_transcribe.py`):
   - Поддерживает два режима выбора источника:
     - `--loopback` — слушает системный микс через WASAPI loopback (по умолчанию берет текущее дефолтное устройство вывода).
     - Без loopback — можно указать индекс входного устройства (`--input`) или оставить `auto` (использует системное по умолчанию или устройство с `cable output` в названии, если оно есть).
   - Читает аудио фреймами (`--frame-ms`), определяет речь (WebRTC VAD, energy threshold или выключено), аккумулирует буфер до окончания фразы и отправляет в Whisper (`--language`, `--whisper-model`).
   - Выводит распознанный текст; при `--chat` задает LLM (Groq) и ведет диалог с системным промптом DevOps-собеседования.

## Возможные улучшения

- **Рефакторинг в src-layout**: перенести скрипты в пакет `src/`, добавить `pyproject.toml`/`setup.cfg`, вынести конфигурацию и вспомогательные функции в модули, покрыть CLI тестами.
- **Логи и отладка**: добавить уровень логирования, флаг `--verbose`, вывод ошибок при работе pycaw/Groq для упрощения диагностики.
- **Устойчивость**: обрабатывать отсутствие VAD, сетевые ошибки Groq, добавлять тайм-ауты и более гибкие критерии окончания фразы.

## Установка и запуск (Windows 10, Python 3.10)

### 1. Установка зависимостей в виртуальное окружение

```powershell
# Установите Python 3.10, затем создайте окружение
py -3.10 -m venv .venv

# Активируйте окружение
.\.venv\Scripts\activate

# Обновите pip и поставьте зависимости
python -m pip install --upgrade pip
python -m pip install -r requirements.txt
```

> При установке `sounddevice` и `webrtcvad` на Windows может понадобиться установленный Microsoft Build Tools.

### 2. Запуск транскрибации через loopback

```powershell
# В активированном окружении
python run_capture_with_audio_switch.py \
    --target-render "Speakers" \
    --whisper-model small \
    --device auto \
    --language ru \
    --vad webrtc \
    --silence-timeout 1.0 \
    --frame-ms 30
```

Ключевые флаги:
- `--target-render` — на какое устройство переключить системный вывод перед запуском (по фрагменту имени); можно не указывать.
- `--loopback` (устанавливается автоматически в раннере) — слушать системный микс дефолтного вывода.
- `--input` — если нужен микрофон или другое устройство, укажите индекс вместо loopback и запустите `stream_transcribe.py` напрямую (см. ниже).
- `--chat` и `--groq-model` — включить диалог с LLM через Groq API (нужен токен в окружении `GROQ_API_KEY`).

### 3. Прямой запуск стриминга (например, с микрофона)

```powershell
python stream_transcribe.py --whisper-model small --input auto --vad webrtc
```

## Переход на Core Audio / loopback

- Работа без VB-Cable уже реализована: pycaw управляет выбором устройства, а звук читается через WASAPI loopback в `stream_transcribe.py`.
- При необходимости можно развить подход и вынести управление устройствами в отдельный модуль, добавить автодетект конкретных брендов устройств и улучшить обработку ошибок.

